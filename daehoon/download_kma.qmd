---
title: "download_kma"
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    toc-location: left
    code-fold: show
    code-summary: "코드 보기"
    code-overflow: wrap
    number-sections: true
    smooth-scroll: true
    embed-resources: true
    df-print: paged
    page-layout: full
editor: visual
---

```{r}
library(tidyverse)
library(sf)
library(data.table)
library(terra)
library(ncdf4)
library(httr)
library(exactextractr)
library(future)
library(future.apply)
library(future.mirai)
library(readxl)
library(arrow)

# 측정소 데이터

file_path <- "raw_data_files/sites_history_cleaning_20250311.xlsx"
sites <- read_excel(file_path)

sites_2020 <- sites %>%
  filter(year == 2020) %>%
  select(TMSID, year, site_type, longitude_common, latitude_common, date_start, date_end)

sites_2020_sf <- st_as_sf(sites_2020, 
                     coords = c("longitude_common", "latitude_common"), 
                     crs = 4326)
```

# 환경변수 데이터

## KMA

```{r}
library(httr)
library(terra)
library(data.table)

## =============================================================================
## [변수 목록 정리 (KMA 고해상도 격자자료 500m)]
## -----------------------------------------------------------------------------
## 1. obs_avg_list: 5분 단위(일 288회) 데이터를 수집하여 일평균을 산출하는 요소
##    - ta     : 기온 (Temperature)
##    - hm     : 상대습도 (Relative Humidity)
##    - td     : 이슬점온도 (Dew Point Temperature)
##    - ws_10m : 10분 평균 풍속 (Wind Speed at 10m)
##    - pa     : 현지기압 (Station Pressure)
##    - ps     : 해면기압 (Sea-level Pressure)
##    - vs     : 시정 (Visibility)
##    - ta_chi : 체감온도 (Apparent Temperature)
##
## 2. obs_daily_list: 기상청에서 이미 일 누적/합계로 제공하여 1회만 수집하는 요소
##    - rn_day : 일강수량 (Daily Precipitation)
## =============================================================================

```



```{r}
# 1. 환경 설정
auth_key <- "ycvVaRBcRBuL1WkQXBQbFA"
# 반드시 'apihub-org' 도메인을 사용해야 함
base_url <- "https://apihub-org.kma.go.kr/api/typ01/url/sfc_grid_nc_down.php"
save_root <- "kma_raw_nc" 

if (!dir.exists(save_root)) dir.create(save_root, recursive = TRUE)

obs_list <- c("ta", "hm", "td", "ws_10m", "pa", "ps", "vs", "ta_chi", "rn_day")
years <- 2018:2024

# 2. 다운로드 루프 실행
for (obs in obs_list) {
  var_path <- file.path(save_root, obs)
  if (!dir.exists(var_path)) dir.create(var_path, recursive = TRUE)
  
  for (yr in years) {
    for (mon in 1:12) {
      start_date <- as.Date(paste(yr, mon, "01", sep = "-"))
      end_date <- seq(start_date, by = "month", length.out = 2)[2] - 1
      target_dates <- seq(start_date, end_date, by = "day")
      
      message(paste("\n>>> [전송 시작] 변수:", obs, "|", yr, "년", mon, "월"))
      
      for (date in as.character(target_dates)) {
        formatted_date <- gsub("-", "", date)
        time_steps <- seq(0, 1435, by = 5)
        
        for (ts in time_steps) {
          tm_str <- paste0(formatted_date, sprintf("%02d%02d", ts %/% 60, ts %% 60))
          save_name <- paste0(obs, "_", tm_str, ".nc")
          save_path <- file.path(var_path, save_name)
          
          # [체크] 파일이 이미 존재하고 크기가 500바이트 이상이면 건너뜀
          # (기존 102바이트짜리 에러 파일들은 다시 받기 위해 덮어씀)
          if (file.exists(save_path) && file.info(save_path)$size > 500) next
          
          api_url <- paste0(base_url, "?obs=", obs, "&tm=", tm_str, "&authKey=", auth_key)
          
          res <- tryCatch({
            GET(api_url, config(ssl_verifypeer = FALSE), 
                write_disk(save_path, overwrite = TRUE), timeout(20))
          }, error = function(e) NULL)
          
          # [검증] 받은 파일이 XML 에러 메시지(작은 용량)인지 확인
          if (!is.null(res) && status_code(res) == 200) {
            f_size <- file.info(save_path)$size
            if (f_size < 500) {
              # 데이터가 아닌 에러 메시지이므로 삭제하여 다음 실행 때 다시 시도하게 함
              file.remove(save_path)
            } else {
              cat(".") # 정상 파일 수신 시 점 출력
            }
          }
        }
        cat(paste0(" [", date, " 완료]\n"))
      }
      gc() 
    }
  }
}
```



```{r}
#| eval: false
# 1. 환경 설정
auth_key <- "ycvVaRBcRBuL1WkQXBQbFA"
save_root <- "kma_monthly_nc"
if (!dir.exists(save_root)) dir.create(save_root, recursive = TRUE)

obs_avg_list <- c("ta", "hm", "td", "ws_10m", "pa", "ps", "vs", "ta_chi")
obs_daily_list <- c("rn_day")

# 연도 및 월 설정
years <- 2018:2024
months <- 1:12

# 2. 이중 루프 실행 (연도별 -> 월별)
for (yr in years) {
  for (mon in months) {
    formatted_month <- sprintf("%04d_%02d", yr, mon)
    final_save_path <- file.path(save_root, paste0("kma_", formatted_month, ".nc"))
    
    if (file.exists(final_save_path)) {
      message(paste("[Skip]", formatted_month))
      next
    }
    
    # 해당 월의 날짜 생성
    start_date <- as.Date(paste(yr, mon, "01", sep = "-"))
    end_date <- seq(start_date, by = "month", length.out = 2)[2] - 1
    target_dates <- seq(start_date, end_date, by = "day")
    
    month_stack <- list() # 한 달 치 모든 변수 레이어를 담을 리스트

    for (date in as.character(target_dates)) {
      formatted_date <- gsub("-", "", date)
      daily_vars_list <- list()
      
      # --- 케이스 1: 5분 단위 데이터 평균 산출 ---
      for (obs in obs_avg_list) {
        message(paste("[Processing-Avg]", date, obs))
        daily_temp_stack <- list()
        time_steps <- seq(0, 1435, by = 5)
        
        for (ts in time_steps) {
          tm_str <- paste0(formatted_date, sprintf("%02d%02d", ts %/% 60, ts %% 60))
          temp_file <- tempfile(fileext = ".nc")
          
          api_url <- paste0("https://apihub.kma.go.kr/api/typ01/url/sfc_grid_nc_down.php",
                            "?obs=", obs, "&tm=", tm_str, "&authKey=", auth_key)
          
          res <- tryCatch({
            GET(api_url, config(ssl_verifypeer = FALSE), write_disk(temp_file, overwrite = TRUE), timeout(10))
          }, error = function(e) NULL)
          
          if (!is.null(res) && status_code(res) == 200 && file.info(temp_file)$size > 5000) {
            r <- try(rast(temp_file), silent = TRUE)
            if (!inherits(r, "try-error")) daily_temp_stack[[length(daily_temp_stack) + 1]] <- r
          }
          if (file.exists(temp_file)) file.remove(temp_file)
        }
        
        if (length(daily_temp_stack) > 0) {
          avg_rast <- mean(rast(daily_temp_stack), na.rm = TRUE)
          names(avg_rast) <- paste0(obs, "_", formatted_date) # 변수명_날짜 형식으로 식별자 부여
          daily_vars_list[[obs]] <- avg_rast
        }
      }

      # --- 케이스 2: 일 단위 데이터 수집 ---
      for (obs in obs_daily_list) {
        message(paste("[Processing-Daily]", date, obs))
        tm_str <- paste0(formatted_date, "1200")
        temp_file <- tempfile(fileext = ".nc")
        
        api_url <- paste0("https://apihub.kma.go.kr/api/typ01/url/sfc_grid_nc_down.php",
                          "?obs=", obs, "&tm=", tm_str, "&authKey=", auth_key)
        
        res <- tryCatch({
          GET(api_url, config(ssl_verifypeer = FALSE), write_disk(temp_file, overwrite = TRUE), timeout(10))
        }, error = function(e) NULL)
        
        if (!is.null(res) && status_code(res) == 200 && file.info(temp_file)$size > 5000) {
          r <- try(rast(temp_file), silent = TRUE)
          if (!inherits(r, "try-error")) {
            names(r) <- paste0(obs, "_", formatted_date)
            daily_vars_list[[obs]] <- r
          }
        }
        if (file.exists(temp_file)) file.remove(temp_file)
      }
      
      # 일별 결과물을 월별 스택에 추가
      if (length(daily_vars_list) > 0) {
        month_stack[[length(month_stack) + 1]] <- rast(daily_vars_list)
      }
    }

    # --- 해당 월 전체 통합 저장 ---
    if (length(month_stack) > 0) {
      combined_month_rast <- rast(month_stack)
      writeRaster(combined_month_rast, final_save_path, overwrite = TRUE)
      message(paste("==> Monthly Success:", final_save_path))
    }
    gc() 
  }
}
```


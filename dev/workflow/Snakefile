configfile: "config.yaml"

import os

YEARS = config["years"]

rule all:
    input:
        # year별 예측 결과
        expand(os.path.join(config["output_dir"], "predictions_{year}.gpkg"), year=YEARS),
        # 비교 결과(전역 1개)
        os.path.join(config["output_dir"], "model_comparison.csv")


# ---------------------------
# Preprocess rasters
# ---------------------------

rule preprocess_landuse:
    """
    Produce one landuse frequency raster per year.
    NOTE: scripts/preprocess_landuse.py should use snakemake.wildcards.year
          (or snakemake.params.year) to decide which year to process.
    """
    input:
        landuse_files=os.path.join(config["data_dir"], config["landuse_dir"], "lc_glc_fcs30d_30m_{year}.tif")
        # landuse_files=lambda wc: [
        #     os.path.join(config["data_dir"], config["landuse_dir"], f)
        #     for f in os.listdir(os.path.join(config["data_dir"], config["landuse_dir"]))
        #     if f.endswith(".tif")
        # ]
    output:
        freq_raster=os.path.join(config["output_dir"], "landuse_freq_{year}.tif")
    params:
        year=lambda wc: wc.year
    shell:
        """
        ../../rust_tools/geotiff_focal_mean/target/release/focal-mean \
            --input {input.landuse_files} \
            --output {output.freq_raster} \
            --radius 67 --radius-in-cells \
            --compression DEFLATE --cog \
            --tile-size 512 --threads 22 \
            --verbose --chunksize 2048
        """


rule preprocess_mtpi:
    input:
        mtpi=os.path.join(config["data_dir"], config["files"]["mtpi"])
    output:
        mtpi_1km=os.path.join(config["output_dir"], "mtpi_1km.tif")
    script:
        "scripts/preprocess_mtpi.py"


# ---------------------------
# Prepare tables
# ---------------------------

rule prepare_monitors:
    input:
        sites=os.path.join(config["git_dir"], config["files"]["sites_history"]),
        measurements=os.path.join(config["data_dir"], config["files"]["measurements"])
    output:
        correct=os.path.join(config["output_dir"], "monitors_correct.parquet"),
        incorrect=os.path.join(config["output_dir"], "monitors_incorrect.parquet")
    script:
        "scripts/prepare_monitors.py"


rule prepare_grid:
    input:
        reference=os.path.join(config["data_dir"], config["files"]["watersheds"])
    params:
        resolution=config["grid"]["resolution"]
    output:
        grid_parquet=os.path.join(config["output_dir"], "grid_30m.parquet")
    script:
        "scripts/prepare_grid.py"


# ---------------------------
# Feature engineering
# ---------------------------

rule calc_features_monitors:
    input:
        monitors=os.path.join(config["output_dir"], "monitors_{type}.parquet"),
        dsm=os.path.join(config["data_dir"], config["files"]["dsm"]),
        dem=os.path.join(config["data_dir"], config["files"]["dem"]),
        mtpi=os.path.join(config["data_dir"], config["files"]["mtpi"]),
        mtpi_1km=os.path.join(config["output_dir"], "mtpi_1km.tif"),
        emissions=os.path.join(config["data_dir"], config["files"]["emissions"]),
        watersheds=os.path.join(config["data_dir"], config["files"]["watersheds"])
    params:
        road_dir=os.path.join(config["data_dir"], config["road_dir"]),
        landuse_dir=config["output_dir"]
    output:
        features=os.path.join(config["output_dir"], "features_monitors_{type}.parquet")
    script:
        "scripts/calc_features.py"


rule calc_features_grid:
    """
    Grid features should usually be year-specific if landuse/emissions/etc. vary by year.
    """
    input:
        grid=os.path.join(config["output_dir"], "grid_30m.parquet"),
        dsm=os.path.join(config["data_dir"], config["files"]["dsm"]),
        dem=os.path.join(config["data_dir"], config["files"]["dem"]),
        mtpi=os.path.join(config["data_dir"], config["files"]["mtpi"]),
        mtpi_1km=os.path.join(config["output_dir"], "mtpi_1km.tif"),
        emissions=os.path.join(config["data_dir"], config["files"]["emissions"]),
        watersheds=os.path.join(config["data_dir"], config["files"]["watersheds"]),
        landuse_freq=os.path.join(config["output_dir"], "landuse_freq_{year}.tif")
    params:
        road_dir=os.path.join(config["data_dir"], config["road_dir"]),
        landuse_dir=config["output_dir"],
        year=lambda wc: wc.year
    output:
        features=os.path.join(config["output_dir"], "features_grid_{year}.parquet")
    script:
        "scripts/calc_features.py"


# ---------------------------
# Model training / prediction
# ---------------------------

rule tune_models:
    input:
        features=os.path.join(config["output_dir"], "features_monitors_correct.parquet")
    output:
        params=os.path.join(config["output_dir"], "best_params.json")
    script:
        "scripts/tune_models.py"


rule fit_predict:
    input:
        features_train=os.path.join(config["output_dir"], "features_monitors_correct.parquet"),
        features_grid=os.path.join(config["output_dir"], "features_grid_{year}.parquet"),
        params=os.path.join(config["output_dir"], "best_params.json")
    output:
        predictions=os.path.join(config["output_dir"], "predictions_{year}.gpkg")
    params:
        year=lambda wc: wc.year
    script:
        "scripts/fit_predict.py"


rule compare_models:
    input:
        correct=os.path.join(config["output_dir"], "features_monitors_correct.parquet"),
        incorrect=os.path.join(config["output_dir"], "features_monitors_incorrect.parquet"),
        params=os.path.join(config["output_dir"], "best_params.json")
    output:
        comparison=os.path.join(config["output_dir"], "model_comparison.csv")
    script:
        "scripts/compare_models.py"

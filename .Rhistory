W_center <- slag(center)
W_U1 <- slag(U1)
W_U2 <- slag(U2)
W_X1 <- slag(X1)
W_X2 <- slag(X2)
###############################################################
# 5. Treatment T 생성 (U1,U2,U0 기반 비무작위 배정)
###############################################################
T_prob <- plogis(-1 + 0.1*U1 + 0.1*U2 + 0.1*U0 + 0.5*W_center)
T <- rbinom(n, 1, T_prob)
# Spatial lag of treatment
WT <- slag(T)
###############################################################
# 6. Potential outcomes Y(0), Y(1) 생성 (Spatial Durbin 구조)
###############################################################
# Baseline outcome Y_pre (center 기반)
Y_pre <- -1 + (-0.7)*center + rnorm(n)
# True treatment effect (heterogeneous)
TE_true <- -2 + 0.8*U1 + 0.8*U2 + 0.5*center + 0.4*W_center + rnorm(n)
# Potential outcome Y0 (control)
Y0 <- Y_pre + 0.4*U1 + 0.3*U2 + 0.2*slag(Y_pre) + rnorm(n)
# Potential outcome Y1 (treated)
Y1 <- Y0 + TE_true
###############################################################
# 7. Observed outcome Y (factual)
###############################################################
Y <- ifelse(T==1, Y1, Y0)
###############################################################
# 8. Causal Forest 학습 (Spatial Durbin covariates 포함)
###############################################################
covars <- cbind(center, U1, U2, X1, X2,
W_center, W_U1, W_U2, W_X1, W_X2, WT)
cf <- causal_forest(
X = covars,
Y = Y,
W = T,
num.trees = 2000
)
###############################################################
# 9. CATE 추정
###############################################################
cate_hat <- predict(cf)$predictions
###############################################################
# 10. 지도 시각화용 데이터프레임 구성
###############################################################
df_map <- data.frame(
coords,
center = center,
U1 = U1,
U2 = U2,
X1 = X1,
X2 = X2,
T = T,
W_center = W_center,
TE_true = TE_true,
CATE = cate_hat
)
map_tile <- function(df, var, title){
ggplot(df, aes(x, y, fill = !!sym(var))) +
geom_tile() +
coord_equal() +
theme_minimal(base_size = 13) +
scale_fill_viridis_c(option="magma") +
labs(title = title, fill = var)
}
# 패널 그리기 예시:
p1 <- map_tile(df_map, "U1", "U1 (confounder)")
p2 <- map_tile(df_map, "U2", "U2 (confounder)")
p3 <- map_tile(df_map, "center", "Center dummy")
p4 <- map_tile(df_map, "T", "Treatment T")
p5 <- map_tile(df_map, "CATE", "Estimated CATE")
(p1 | p2 | p3) /
(p4 | p5)
# 5. Treatment T 생성 (U1,U2,U0 기반 비무작위 배정)
###############################################################
T_prob <- plogis(-1 + 0.1*U1 + 0.1*U2 + 0.1*U0 + 3*W_center)
T <- rbinom(n, 1, T_prob)
# Spatial lag of treatment
WT <- slag(T)
###############################################################
# 6. Potential outcomes Y(0), Y(1) 생성 (Spatial Durbin 구조)
###############################################################
# Baseline outcome Y_pre (center 기반)
Y_pre <- -1 + (-0.7)*center + rnorm(n)
# True treatment effect (heterogeneous)
TE_true <- -2 + 0.8*U1 + 0.8*U2 + 0.5*center + 0.4*W_center + rnorm(n)
# Potential outcome Y0 (control)
Y0 <- Y_pre + 0.4*U1 + 0.3*U2 + 0.2*slag(Y_pre) + rnorm(n)
# Potential outcome Y1 (treated)
Y1 <- Y0 + TE_true
###############################################################
# 7. Observed outcome Y (factual)
###############################################################
Y <- ifelse(T==1, Y1, Y0)
###############################################################
# 8. Causal Forest 학습 (Spatial Durbin covariates 포함)
###############################################################
covars <- cbind(center, U1, U2, X1, X2,
W_center, W_U1, W_U2, W_X1, W_X2, WT)
cf <- causal_forest(
X = covars,
Y = Y,
W = T,
num.trees = 2000
)
###############################################################
# 9. CATE 추정
###############################################################
cate_hat <- predict(cf)$predictions
###############################################################
# 10. 지도 시각화용 데이터프레임 구성
###############################################################
df_map <- data.frame(
coords,
center = center,
U1 = U1,
U2 = U2,
X1 = X1,
X2 = X2,
T = T,
W_center = W_center,
TE_true = TE_true,
CATE = cate_hat
)
map_tile <- function(df, var, title){
ggplot(df, aes(x, y, fill = !!sym(var))) +
geom_tile() +
coord_equal() +
theme_minimal(base_size = 13) +
scale_fill_viridis_c(option="magma") +
labs(title = title, fill = var)
}
# 패널 그리기 예시:
p1 <- map_tile(df_map, "U1", "U1 (confounder)")
p2 <- map_tile(df_map, "U2", "U2 (confounder)")
p3 <- map_tile(df_map, "center", "Center dummy")
p4 <- map_tile(df_map, "T", "Treatment T")
p5 <- map_tile(df_map, "CATE", "Estimated CATE")
(p1 | p2 | p3) /
(p4 | p5)
# 5. Treatment T 생성 (U1,U2,U0 기반 비무작위 배정)
###############################################################
T_prob <- plogis(-1 + 0.1*U1 + 0.1*U2 + 0.1*U0 + 10*W_center)
T <- rbinom(n, 1, T_prob)
# Spatial lag of treatment
WT <- slag(T)
###############################################################
# 6. Potential outcomes Y(0), Y(1) 생성 (Spatial Durbin 구조)
###############################################################
# Baseline outcome Y_pre (center 기반)
Y_pre <- -1 + (-0.7)*center + rnorm(n)
# True treatment effect (heterogeneous)
TE_true <- -2 + 0.8*U1 + 0.8*U2 + 0.5*center + 0.4*W_center + rnorm(n)
# Potential outcome Y0 (control)
Y0 <- Y_pre + 0.4*U1 + 0.3*U2 + 0.2*slag(Y_pre) + rnorm(n)
# Potential outcome Y1 (treated)
Y1 <- Y0 + TE_true
###############################################################
# 7. Observed outcome Y (factual)
###############################################################
Y <- ifelse(T==1, Y1, Y0)
###############################################################
# 8. Causal Forest 학습 (Spatial Durbin covariates 포함)
###############################################################
covars <- cbind(center, U1, U2, X1, X2,
W_center, W_U1, W_U2, W_X1, W_X2, WT)
cf <- causal_forest(
X = covars,
Y = Y,
W = T,
num.trees = 2000
)
###############################################################
# 9. CATE 추정
###############################################################
cate_hat <- predict(cf)$predictions
###############################################################
# 10. 지도 시각화용 데이터프레임 구성
###############################################################
df_map <- data.frame(
coords,
center = center,
U1 = U1,
U2 = U2,
X1 = X1,
X2 = X2,
T = T,
W_center = W_center,
TE_true = TE_true,
CATE = cate_hat
)
map_tile <- function(df, var, title){
ggplot(df, aes(x, y, fill = !!sym(var))) +
geom_tile() +
coord_equal() +
theme_minimal(base_size = 13) +
scale_fill_viridis_c(option="magma") +
labs(title = title, fill = var)
}
# 패널 그리기 예시:
p1 <- map_tile(df_map, "U1", "U1 (confounder)")
p2 <- map_tile(df_map, "U2", "U2 (confounder)")
p3 <- map_tile(df_map, "center", "Center dummy")
p4 <- map_tile(df_map, "T", "Treatment T")
p5 <- map_tile(df_map, "CATE", "Estimated CATE")
(p1 | p2 | p3) /
(p4 | p5)
library(MASS)
library(spdep)
library(grf)
library(FNN)
library(faux)
library(ggplot2)
library(patchwork)
set.seed(123)
###############################################################
# 1. 연구 지역 coords (35 x 25 = 500 grid)
###############################################################
coords <- expand.grid(x = 1:35, y = 1:25)
n <- nrow(coords)
###############################################################
# 2. 중심 지역(center dummy) 생성
###############################################################
center <- ifelse(coords$x >=10 & coords$x <=25 &
coords$y >=8  & coords$y <=18, 1, 0)
###############################################################
# 3. 공변수 + 교란변수 생성 (center 기반 correlation 부여)
###############################################################
# 공변수들: X1,X2 (무작위, center와 무관)
X1 <- rnorm(n)
X2 <- rnorm(n)
# confounders: U1, U2, U0 (center와 상관구조를 가짐)
Sigma <- matrix(c(1,0.7,0.5,
0.7,1,0.4,
0.5,0.4,1), ncol=3)
raw <- mvrnorm(n, mu=c(0,0,0), Sigma=Sigma)
x_scaled <- (coords$x - min(coords$x)) / (max(coords$x) - min(coords$x))
# 새로운 U2 생성
U1 <-  2*center + raw[,1]
U2 <- 1 * center + 2.0 * x_scaled + rnorm(n, 0, 0.5)
U0 <-  0.5*center + raw[,3]   # omitted confounder
###############################################################
# 4. Spatial Durbin용 공간가중행렬 W (K=6 nearest neighbors)
###############################################################
coords_mat <- as.matrix(coords)
knn_nb <- knn2nb(knearneigh(coords_mat, k=6))
W <- nb2mat(knn_nb, style="W")   # row-standardized
# Spatial lag 함수
slag <- function(v) as.numeric(W %*% v)
# Spatial Durbin covariates 생성
W_center <- slag(center)
W_U1 <- slag(U1)
W_U2 <- slag(U2)
W_X1 <- slag(X1)
W_X2 <- slag(X2)
###############################################################
# 5. Treatment T 생성 (U1,U2,U0 기반 비무작위 배정)
###############################################################
T_prob <- plogis(-1 + 0.1*U1 + 0.1*U2 + 0.1*U0 + 10*W_center)
T <- rbinom(n, 1, T_prob)
# Spatial lag of treatment
WT <- slag(T)
###############################################################
# 6. Potential outcomes Y(0), Y(1) 생성 (Spatial Durbin 구조)
###############################################################
# Baseline outcome Y_pre (center 기반)
Y_pre <- -1 + (-0.7)*center + rnorm(n)
# True treatment effect (heterogeneous)
TE_true <- -2 + 0.8*U1 + 0.8*U2 + 0.5*center + 0.4*W_center + rnorm(n)
# Potential outcome Y0 (control)
Y0 <- Y_pre + 0.4*U1 + 0.3*U2 + 0.2*slag(Y_pre) + rnorm(n)
# Potential outcome Y1 (treated)
Y1 <- Y0 + TE_true
###############################################################
# 7. Observed outcome Y (factual)
###############################################################
Y <- ifelse(T==1, Y1, Y0)
###############################################################
# 8. Causal Forest 학습 (Spatial Durbin covariates 포함)
###############################################################
covars <- cbind(center, U1, U2, X1, X2,
W_center, W_U1, W_U2, W_X1, W_X2, WT)
cf <- causal_forest(
X = covars,
Y = Y,
W = T,
num.trees = 2000
)
###############################################################
# 9. CATE 추정
###############################################################
cate_hat <- predict(cf)$predictions
###############################################################
# 10. 지도 시각화용 데이터프레임 구성
###############################################################
df_map <- data.frame(
coords,
center = center,
U1 = U1,
U2 = U2,
X1 = X1,
X2 = X2,
T = T,
W_center = W_center,
TE_true = TE_true,
CATE = cate_hat
)
map_tile <- function(df, var, title){
ggplot(df, aes(x, y, fill = !!sym(var))) +
geom_tile() +
coord_equal() +
theme_minimal(base_size = 13) +
scale_fill_viridis_c(option="magma") +
labs(title = title, fill = var)
}
# 패널 그리기 예시:
p1 <- map_tile(df_map, "U1", "U1 (confounder)")
p2 <- map_tile(df_map, "U2", "U2 (confounder)")
p3 <- map_tile(df_map, "center", "Center dummy")
p4 <- map_tile(df_map, "T", "Treatment T")
p5 <- map_tile(df_map, "CATE", "Estimated CATE")
(p1 | p2 | p3) /
(p4 | p5)
library(MASS)
library(spdep)
library(grf)
library(FNN)
library(faux)
library(ggplot2)
library(patchwork)
set.seed(123)
###############################################################
# 1. 연구 지역 coords (35 x 25 = 500 grid)
###############################################################
coords <- expand.grid(x = 1:35, y = 1:25)
n <- nrow(coords)
###############################################################
# 2. 중심 지역(center dummy) 생성
###############################################################
center <- ifelse(coords$x >=10 & coords$x <=25 &
coords$y >=8  & coords$y <=18, 1, 0)
###############################################################
# 3. 공변수 + 교란변수 생성 (center 기반 correlation 부여)
###############################################################
# 공변수들: X1,X2 (무작위, center와 무관)
X1 <- rnorm(n)
X2 <- rnorm(n)
# confounders: U1, U2, U0 (center와 상관구조를 가짐)
Sigma <- matrix(c(1,0.7,0.5,
0.7,1,0.4,
0.5,0.4,1), ncol=3)
raw <- mvrnorm(n, mu=c(0,0,0), Sigma=Sigma)
x_scaled <- (coords$x - min(coords$x)) / (max(coords$x) - min(coords$x))
# 새로운 U2 생성
U1 <-  2*center + raw[,1]
U2 <- 1 * center + 3.0 * x_scaled + rnorm(n, 0, 0.5)
U0 <-  0.5*center + raw[,3]   # omitted confounder
###############################################################
# 4. Spatial Durbin용 공간가중행렬 W (K=6 nearest neighbors)
###############################################################
coords_mat <- as.matrix(coords)
knn_nb <- knn2nb(knearneigh(coords_mat, k=6))
W <- nb2mat(knn_nb, style="W")   # row-standardized
# Spatial lag 함수
slag <- function(v) as.numeric(W %*% v)
# Spatial Durbin covariates 생성
W_center <- slag(center)
W_U1 <- slag(U1)
W_U2 <- slag(U2)
W_X1 <- slag(X1)
W_X2 <- slag(X2)
###############################################################
# 5. Treatment T 생성 (U1,U2,U0 기반 비무작위 배정)
###############################################################
T_prob <- plogis(-1 + 0.1*U1 + 0.1*U2 + 0.1*U0 + 10*W_center)
T <- rbinom(n, 1, T_prob)
# Spatial lag of treatment
WT <- slag(T)
###############################################################
# 6. Potential outcomes Y(0), Y(1) 생성 (Spatial Durbin 구조)
###############################################################
# Baseline outcome Y_pre (center 기반)
Y_pre <- -1 + (-0.7)*center + rnorm(n)
# True treatment effect (heterogeneous)
TE_true <- -2 + 0.8*U1 + 0.8*U2 + 0.5*center + 0.4*W_center + rnorm(n)
# Potential outcome Y0 (control)
Y0 <- Y_pre + 0.4*U1 + 0.3*U2 + 0.2*slag(Y_pre) + rnorm(n)
# Potential outcome Y1 (treated)
Y1 <- Y0 + TE_true
###############################################################
# 7. Observed outcome Y (factual)
###############################################################
Y <- ifelse(T==1, Y1, Y0)
###############################################################
# 8. Causal Forest 학습 (Spatial Durbin covariates 포함)
###############################################################
covars <- cbind(center, U1, U2, X1, X2,
W_center, W_U1, W_U2, W_X1, W_X2, WT)
cf <- causal_forest(
X = covars,
Y = Y,
W = T,
num.trees = 2000
)
###############################################################
# 9. CATE 추정
###############################################################
cate_hat <- predict(cf)$predictions
###############################################################
# 10. 지도 시각화용 데이터프레임 구성
###############################################################
df_map <- data.frame(
coords,
center = center,
U1 = U1,
U2 = U2,
X1 = X1,
X2 = X2,
T = T,
W_center = W_center,
TE_true = TE_true,
CATE = cate_hat
)
map_tile <- function(df, var, title){
ggplot(df, aes(x, y, fill = !!sym(var))) +
geom_tile() +
coord_equal() +
theme_minimal(base_size = 13) +
scale_fill_viridis_c(option="magma") +
labs(title = title, fill = var)
}
# 패널 그리기 예시:
p1 <- map_tile(df_map, "U1", "U1 (confounder)")
p2 <- map_tile(df_map, "U2", "U2 (confounder)")
p3 <- map_tile(df_map, "center", "Center dummy")
p4 <- map_tile(df_map, "T", "Treatment T")
p5 <- map_tile(df_map, "CATE", "Estimated CATE")
(p1 | p2 | p3) /
(p4 | p5)
extracted_raw
sites_buffer_10m
sites_buffer_10m <- sites_2020_sf %>%
st_transform(5186) %>%
st_buffer(dist = 10) %>%
st_transform(4326)
library(tidyverse)
library(sf)
library(data.table)
library(terra)
library(ncdf4)
library(future)
library(future.apply)
library(future.mirai)
library(readxl)
# 1. 대상 파일 목록 정렬 및 임시 디렉터리 설정
zip_files <- sort(list.files("ERA5_Land", pattern = "\\.zip$", full.names = TRUE))
temp_root <- file.path(tempdir(), "era5_unpack")
if (!dir.exists(temp_root)) dir.create(temp_root)
# 2. 개별 파일 압축 해제 및 리스트 저장
raster_list <- list()
for (i in seq_along(zip_files)) {
# 파일명 충돌 방지를 위해 루프 인덱스별 하위 폴더 생성
target_dir <- file.path(temp_root, paste0("vol_", i))
dir.create(target_dir, showWarnings = FALSE)
# data_0.nc 압축 해제
unzip(zip_files[i], files = "data_0.nc", exdir = target_dir)
# SpatRaster 객체 생성 및 리스트에 할당
raster_list[[i]] <- rast(file.path(target_dir, "data_0.nc"))
}
# 3. 전역 변수 era5_land_2020으로 통합 객체 생성
era5_land_2020 <- rast(raster_list)
# 객체 구조 확인
print(era5_land_2020)
file_path <- "raw_data_files/sites_history_cleaning_20250311.xlsx"
sites <- read_excel(file_path)
sites_2020 <- sites %>%
filter(year == 2020) %>%
select(TMSID, year, site_type, longitude_common, latitude_common)
sites_2020_sf <- st_as_sf(sites_2020,
coords = c("longitude_common", "latitude_common"),
crs = 4326)
sites_buffer_10m <- sites_2020_sf %>%
st_transform(5186) %>%
st_buffer(dist = 10) %>%
st_transform(4326)
vect(sites_buffer_10m)
era5_land_2020
library(exactexactr)
if (!requireNamespace("exactextractr", quietly = TRUE)) install.packages("exactextractr")
library(exactextractr)
print(tp_10m_era5_land_2020[1:5,1:10])
library(targets)
install.packages(c("targets", "tarchetypes"))
library(targets)
tar_visnetwork()
getwd()
setwd("C:/Users/dhnss/OneDrive/daeworks/huimori")
tar_visnetwork()
install.packages('crew')
tar_visnetwork()
tar_make()
install.packages(c("bonsai", "finetune", "lightgbm"))
devtools::install(quick=T, upgrade=F)
devtools::install(quick=T, upgrade=F)
devtools::install()
devtools::install()
install.packages('feasts')
devtools::install()
devtools::install(dep = T)
devtools::install(dep = TRUE)
tar_make(chr_monitors_file)
tar_visnetwork()
